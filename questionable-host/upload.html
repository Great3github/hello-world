<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Upload a file</title>
    <meta
      name="description"
      content="This page doesn't work on its own. You'll need to install a userscript first."
    />

    <link rel="stylesheet" type="text/css" href="/sheep3.css" />
    <script src="/sheep3.js" charset="utf-8"></script>

    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <form class="main" id="uploader">
      <div class="progress-bar progress-done" id="progress"></div>
      <fieldset class="container" id="fieldset">
        <h1>Upload a file</h1>
        <label class="text-label">
          File
          <input type="file" name="files" id="files" multiple />
        </label>
        <label class="checkbox-label">
          <input type="checkbox" name="compressed" id="compressed" checked />
          Compress files before uploading?
        </label>
        <input type="submit" value="Upload" />
      </fieldset>
    </form>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.3/pako.min.js"></script>
    <script>
      if (window.parent === window) {
        window.location.replace('./instructions.html')
      }

      const files = document.getElementById('files')
      const compressCheckbox = document.getElementById('compressed')
      const progress = document.getElementById('progress')
      const submitForm = document.getElementById('uploader')
      const fieldset = document.getElementById('fieldset')
      let blobCount
      submitForm.addEventListener('submit', async e => {
        e.preventDefault()
        const blobs = compressCheckbox.checked
          ? await Promise.all(
              Array.from(
                files.files,
                async file => new Blob([pako.deflate(await file.arrayBuffer())])
              )
            )
          : [...files.files]
        window.parent.postMessage({
          type: 'upload',
          blobs
        }, '*')
        blobCount = blobs.length
        fieldset.disabled = true
        progress.classList.remove('progress-done')
        progress.classList.remove('progress-error')
        progress.style.width = 0
      })
      window.addEventListener('message', ({ data }) => {
        switch (data.type) {
          case 'progress': {
            progress.style.width =
              ((data.blobIndex + data.percent) / blobCount) * 100 + '%'
            break
          }
          case 'error': {
            fieldset.disabled = false
            progress.style.width = null
            progress.classList.add('progress-error')
            break
          }
          case 'done': {
            fieldset.disabled = false
            progress.style.width = null
            progress.classList.add('progress-done')
            console.log(data.hashes)
            break
          }
          default: {
            console.warn('Received a strange message.', data)
          }
        }
      })
    </script>
  </body>
</html>
